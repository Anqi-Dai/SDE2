---
title: "Fig1"
author: "Anqi Dai"
date: "2/14/2019"
output: html_document
--- 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

```{r}
library(tidyverse)
library(ggpubr)
library(Biobase)
library(knitr)
library(kableExtra)
```

## 1A: Pie chart

A pie chart showing the number of types of AS events from all three tools. Merging the rMATS one into the other 2 is pain, but I can and will do that.

### Merge the rMATS results together

```{r}
# The JCEC.txt files of the AS types
path <- '../../06_rMATS/data/rMATS_result/RF14_control'
fns <- file.path(path, list.files(path, 'JCEC.txt'))

# A3SS 
A3SS <- read_tsv(fns[1]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, longExonStart_0base, shortES, geneSymbol, FDR) %>%
  rename(start = longExonStart_0base, end = shortES, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(start = start + 1) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'AA') %>%
  dplyr::select(-chr, -start,-end)

# A5SS 
A5SS <- read_tsv(fns[2]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, shortEE, longExonEnd, geneSymbol, FDR) %>%
  rename(start = shortEE, end = longExonEnd, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'AD') %>%
  dplyr::select(-chr, -start,-end)
  
# RI 
RI <- read_tsv(fns[4]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, upstreamEE, downstreamES, geneSymbol, FDR) %>%
  rename(start = upstreamEE, end = downstreamES, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'RI') %>%
  dplyr::select(-chr, -start,-end)

# SE
SE <-  read_tsv(fns[5]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, exonStart_0base, exonEnd, geneSymbol, FDR) %>%
  rename(start = exonStart_0base, end = exonEnd, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(start = start + 1) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'CE') %>%
  dplyr::select(-chr, -start,-end)

# MXE
MXE <- read_tsv(fns[3]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, upstreamES, downstreamEE, geneSymbol, FDR) %>%
  rename(start = upstreamES, end = downstreamEE, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'MXE') %>%
  dplyr::select(-chr, -start,-end)
```

```{r}
df14 <- bind_rows(A3SS, A5SS, RI, SE, MXE) %>%
  filter(!duplicated(locus)) 
```

```{r}
# The JCEC.txt files of the AS types
path <- '../../06_rMATS/data/rMATS_result/RF89_control'
fns <- file.path(path, list.files(path, 'JCEC.txt'))

# A3SS 
A3SS <- read_tsv(fns[1]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, longExonStart_0base, shortES, geneSymbol, FDR) %>%
  rename(start = longExonStart_0base, end = shortES, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(start = start + 1) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'AA') %>%
  dplyr::select(-chr, -start,-end)

# A5SS 
A5SS <- read_tsv(fns[2]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, shortEE, longExonEnd, geneSymbol, FDR) %>%
  rename(start = shortEE, end = longExonEnd, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'AD') %>%
  dplyr::select(-chr, -start,-end)
  
# RI 
RI <- read_tsv(fns[4]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, upstreamEE, downstreamES, geneSymbol, FDR) %>%
  rename(start = upstreamEE, end = downstreamES, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'RI') %>%
  dplyr::select(-chr, -start,-end)

# SE
SE <-  read_tsv(fns[5]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, exonStart_0base, exonEnd, geneSymbol, FDR) %>%
  rename(start = exonStart_0base, end = exonEnd, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(start = start + 1) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'CE') %>%
  dplyr::select(-chr, -start,-end)

# MXE
MXE <- read_tsv(fns[3]) %>%
  filter(FDR < 0.05) %>%
  dplyr::select(chr, upstreamES, downstreamEE, geneSymbol, FDR) %>%
  rename(start = upstreamES, end = downstreamEE, external_gene_name = geneSymbol, significance  = FDR) %>%
  mutate(locus = paste(chr, paste(start,end, sep='-'),sep=':')) %>%
  mutate(tool = 'rMATS',
         type = 'MXE') %>%
  dplyr::select(-chr, -start,-end)
```

```{r}
df89 <- bind_rows(A3SS, A5SS, RI, SE, MXE) %>%
  filter(!duplicated(locus)) 
```

```{r}
# now find the overlap between the 14 and 89 that is the final results
# keep the siginficance from both comparisons 

DF <- df14 %>%
  inner_join(df89 %>%
               rename(sig89 = significance) %>%
               dplyr::select(locus, sig89), by = 'locus')


```

```{r}
# revisiting the whippet and IRfinder combined result
two <- read_csv('../../05_IRfinder/output/Whippet_IRfinder_combined_results_sig_withGeneName.csv') %>%
  mutate(locus = paste(Chr, paste(Start, End, sep='-'),sep=':')) %>%
  rename(tool = Program, type = Type) %>%
  dplyr::select(-Chr, -Start,-End) %>%
  dplyr::select(locus, tool, type, external_gene_name) %>%
  filter(!duplicated(locus)) 
```

```{r}
length(intersect(two$locus, DF$locus))
```

