---
title: "Reading the alignments in fasta format"
author: "Anqi Dai"
date: "7/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(seqinr)
library(tidyverse)
```

The shadedness is the percentage of the dominant nulcetide among all the base in that locus.

```{r}
fasta.res  <- read.alignment(file = '../output/as_all.fa',
 format = "fasta")

# how long is each string
len <- nchar(fasta.res$seq[[1]])
  

res <- fasta.res$seq %>% 
  map(function(str){
  str_split_fixed(str, pattern = '',
                  n = len) %>% 
      as.data.frame(stringsAsFactors = FALSE )
})

ret <- res %>% 
  bind_rows


# converting it to numeric values : -:0, A:1, G:2, C:3, T:4

converting_to_numeric <- function(column){
  case_when(
    column == '-' ~ 0,
    column == 'a' ~ 1,
    column == 'g' ~ 2,
    column == 'c' ~ 3,
    column == 't' ~ 4,
  )
}

num <- apply(ret, 2, converting_to_numeric)

# 0 doesn't engage in any calculations!
# out of the all of the nonzero digits, what is the percentage of the dominant digit? in each column?

# find out the nonzero digit in each column
total_nonzeros <- colSums(num != 0) %>% 
  as.data.frame(stringsAsFactors = FALSE) %>% 
  rownames_to_column('colu_name') %>% 
  rename(total_non0 = names(.)[2])

# find the most dominant nt and its number in each column
domninant <- apply(num, 2, function(colu){
  ret = sort(table(colu)) %>% 
    as.data.frame 
  return(ret)
})
# for some reason there are columns went rouge
# find how many rows each item in the list dominant has
n_row <- map_dfr(domninant, ~nrow(.)) %>% 
  gather(key = 'id',
         value = 'num') %>% 
  group_by(num) %>% 
  summarise(cnt = n())

# finding out the weird items with only one row and remove it in the list
ids_rm <- n_row <- map_dfr(domninant, ~nrow(.)) %>% 
  gather(key = 'id',
         value = 'num') %>% 
  filter(num == 1) %>% 
  pull(id)

num_rm <- num[,-c(48, 654)]

domninant_rm <- apply(num_rm, 2, function(colu){
  ret = sort(table(colu)) %>% 
    as.data.frame(stringsAsFactors = FALSE ) %>% 
    filter(colu != 0) %>% 
    filter(Freq == max(Freq)) %>% 
    head(1) 
  return(ret)
}) 

RES <- domninant_rm %>% 
  bind_rows %>% 
  mutate(colu_name = names(domninant_rm))

# now join them together to have a table with both total number of nonzeros and the number of dominant digits
# totalnonzero should be at least 80% of the total sequences
result <- RES %>% 
  left_join(total_nonzeros, by= 'colu_name') %>% 
  arrange(desc(Freq)) %>% 
  mutate(total_seq = fasta.res$nb) %>% 
  mutate(perc_nonzero = total_non0/total_seq) %>% 
  filter(perc_nonzero > 0.9) %>% 
  mutate(perc_domi = )
```

