---
title: "04_Fig4"
author: "Anqi Dai"
date: "4/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
```

```{r}
# load the result table
res <- read_csv('../../05_IRfinder/data/IRfinder.res.filtered.14n89.analysis2.csv') %>%
  filter(Group == 'RF14') %>%
  mutate(Significance = factor(if_else(Significance == 'TRUE', 'Sig', 'Non-sig')))
```

# SiSDE2-1 (Si14 only)

```{r}
table(res$Significance)

```

## SDE2 IR events VS IRfinder events

```{r}
compare <- read_csv('../output/paper and our KD events compare.csv')

compare_plot <- compare %>%
  filter(! str_detect(gene, 'union')) %>%
  mutate(gene = str_replace(gene, 'RF', 'Si'))  %>%
  mutate(group = if_else(str_detect(gene, 'SDE2'), 'our', 'paper')) %>%
  ggbarplot(x = 'gene', y ='increased',
            color = 'group', fill = 'group',
            ylab = 'Number of events',
            title = 'Comparison of increased IR events after gene KD')  +
  ylim(0, 5000) +
  geom_text(aes(label = increased_in_perc), vjust = -1, size = 3 ) +
  scale_color_manual(values = c('#EEBF2B', '#1175C0'))  +
  scale_fill_manual(values = c('#EEBF2B', '#1175C0'))  +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
      axis.text=element_text(size=8),
      axis.title.x=element_blank(),
      legend.position = "none")
```


## Position

```{r}
pos <- res %>%
  gghistogram(x = 'RI_prop',
              palette = 'lancet',
              color = 'white', fill = 'Significance', 
              bins = 40,
              add = "median",
              title = 'Histogram of RI position (median shown)',
              xlab = 'RI position')
```

## GC content

```{r}
gc <- res %>%
    gghistogram(x = 'GC_per',
              palette = 'lancet',
              color = 'white', fill = 'Significance', 
              bins = 40,
              add = "median",
              title = 'Histogram of GC% (median shown)',
              xlab = 'GC% ') 
  
```

## Splice site strength

```{r}
strength <- res %>%
  dplyr::select(Locus, Significance, ss5_score, ss3_score) %>%
  ggboxplot(x = 'Significance', y = c('ss5_score','ss3_score'),combine = T,
            ylab = 'Score', xlab = '',
            #add = 'jitter', 
            add.params = list(alpha = 0.15, fill = 'Significance'),
            title = 'Distribution of the ss5 and ss3 MaxEnt score',
            palette = 'lancet', color = 'Significance')   +
  stat_compare_means(comparisons = list(c('Sig', 'Non-sig')))
```

## Length

```{r}
len <- res %>%
  ggboxplot(x = "Significance", y = 'RI_len', 
            ylab = 'Length of retained intron',
            title = 'Len of RI boxplot') 
```

## GSEA 

```{r}
# the gsea of the significant genes
res %>%
  filter(Significance == 'Significant') %>%
  distinct(GeneID)  %>%
  write_csv('../data/unique_gene_id_for_significant_day3.csv', col_names = F)

# plot the -log10(q) value from Metascape results (top 10)
gsea <- read_csv('../output/Metascape/day3_sig_gene/all/Enrichment_GO/GO_AllLists.csv') %>%
  top_n(n = -10, wt = `Log(q-value)`) %>%
  mutate(neg_log_q = abs(`Log(q-value)`)) %>%
  mutate(Description = str_replace(Description, ' \\(..+$','')) 

gsea_plot <- gsea %>%
  ggbarplot(x = 'Description', y = 'neg_log_q',
            xlab = '', ylab = '-log10(q)',
            title = 'GSEA of the genes with significant RI', color = 'white',
            fill = 'neg_log_q') +
  coord_flip() +
  theme(axis.text.y = element_text(size = 7),
        legend.position="none")

```

## Assemble

```{r}
ggarrange(compare_plot, pos, gc, strength, len, gsea_plot, 
          ncol = 2, nrow = 3, 
          align = c("v"),
          labels = 'auto', label.x = 0, hjust = -3) +
  ggsave('../figs/Assembled_fig4.jpg', width = 8, height = 12, dpi = 300)
```

