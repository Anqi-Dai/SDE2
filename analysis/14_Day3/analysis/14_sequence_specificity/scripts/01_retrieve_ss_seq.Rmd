---
title: "Retrieve sequences near splice site"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
library(tidyverse)
library(knitr)
library(kableExtra)
```

```{r}
# get the sig and non sig separatly for two comparisons.
# FLIP THE START AND END COORD FOR THE EVENT ON THE NEGATIVE STRAND!
data_path <- '../../05_IRfinder/data/rawIRfinderResult/'
fns <- list.files(data_path, pattern = 'txt', full.names = T)

sig <- fns %>%
  map(~ read_tsv(.,comment = '#',col_names = T)  %>%
        mutate(Start = Start + 1) %>%
        mutate(locus = paste(Chr,paste(Start, End, sep = '-'), sep = ':' ) ) %>%
        rename_all(funs(stringr::str_replace_all(., '-', '_') )) %>%
        separate(names(.)[4], into = c('Symbol', 'GeneID', 'Category'), sep = '/') %>%
        mutate(GeneID = str_replace_all(string = GeneID, pattern = '\\..*$', replacement = ''),
               padj = p.adjust(p_diff, method = 'BH')) %>%
        filter(! Category == 'known-exon') %>%
        filter(A_IRok != 'MinorIsoform' &  B_IRok != 'MinorIsoform' ) %>%
        filter(padj < 0.05) 
      )

non_Sig <- fns %>%
  map(~ read_tsv(.,comment = '#',col_names = T)  %>%
        mutate(Start = Start + 1) %>%
        mutate(locus = paste(Chr,paste(Start, End, sep = '-'), sep = ':' ) ) %>%
        rename_all(funs(stringr::str_replace_all(., '-', '_') )) %>%
        separate(names(.)[4], into = c('Symbol', 'GeneID', 'Category'), sep = '/') %>%
        mutate(GeneID = str_replace_all(string = GeneID, pattern = '\\..*$', replacement = ''),
               padj = p.adjust(p_diff, method = 'BH')) %>%
        filter(! Category == 'known-exon') %>%
        filter(A_IRok != 'MinorIsoform' &  B_IRok != 'MinorIsoform' ) %>%
        filter(padj >= 0.05) 
      )
```
 
```{r}
# now the sig locus is the intersection
# and the nonSig is still the intersection
sig_locus <- intersect(sig[[1]]$locus, sig[[2]]$locus)

non_Sig_locus <- intersect(non_Sig[[1]]$locus, non_Sig[[2]]$locus)
 
tibble(sig_locus = length(sig_locus),
       non_Sig_locus = length(non_Sig_locus)) 
```
  
```{r}
# finding the true and false locus that are of comparable length
sig_df <-  sig[[1]] %>%
  filter(locus %in% sig_locus) %>%
  dplyr::select(chr = Chr, start = Start, end = End, direction = Direction)  %>%
  mutate(RIlen = end - start,
         catetory = 'Sig') %>%
  arrange(RIlen)  

non_Sig_df <-  non_Sig[[1]] %>%
  filter(locus %in% non_Sig_locus) %>%
  dplyr::select(chr = Chr, start = Start, end = End, direction = Direction)  %>%
  mutate(RIlen = end - start,
         catetory = 'Non-sig') %>%
  arrange(RIlen)  
 
```

```{r}
# bin them into every smaller per bin and count how many in them 

sig_bin <- table(cut_interval(sig_df$RIlen, length=50)) %>%
  as.data.frame %>% 
  select(interval = Var1,
         sig = Freq)
  
non_sig_bin <- table(cut_interval(non_Sig_df$RIlen, length=50)) %>%
  as.data.frame %>% 
  select(interval = Var1,
         non_sig = Freq)

# the way I decided how many to select for each interval
all <- sig_bin %>%
  left_join(non_sig_bin, by = 'interval') %>%
  rowwise() %>%
  mutate(numSelect = min(non_sig, sig)) %>%
  filter(!is.na(numSelect))

# if I can use a df as input for every row
input_all <- all %>%
  mutate(interval = str_replace_all(string = interval, pattern = "]$",replacement = '')) %>%
  mutate(interval = str_replace_all(string = interval, pattern = "\\(|\\[",replacement = '')) %>%
  separate(interval, into = c('lower','upper'), convert = T) %>%
  dplyr::select(-non_sig, -sig) 

```

```{r}
# a function that takes a interval and return the rows that meet that interval

records_in_interval_sig <- function(lower, upper,numSelect) {
  ret = sig_df %>%
    filter(RIlen > lower & RIlen <= upper) %>%
    sample_n(numSelect)
  return(ret)
} 

res_sig <- pmap_dfr(input_all, function(lower, upper, numSelect){
  records_in_interval_sig(lower, upper, numSelect)
})


# for non-as
records_in_interval_non_sig <- function(lower, upper,numSelect) {
  ret = non_Sig_df %>%
    filter(RIlen > lower & RIlen <= upper) %>%
    sample_n(numSelect)
  return(ret)
} 

res_non_sig <- pmap_dfr(input_all, function(lower, upper, numSelect){
  records_in_interval_non_sig(lower, upper, numSelect)
})

```


```{r}
# from here I get the sequences in two groups that have a length < 100 and output the df
out <- bind_rows(
  res_sig %>% 
    filter(RIlen < 100),
  res_non_sig %>% 
    filter(RIlen < 100)
)

out200 <- bind_rows(
  res_sig %>% 
    filter(RIlen < 200),
  res_non_sig %>% 
    filter(RIlen < 200)
)

out %>% 
  write_csv('../output/two_groups_seq_info_len_100.csv')

out200 %>% 
  write_csv('../output/two_groups_seq_info_len_200.csv')
```


```{r}
# generate the start and end coord for 5 and 3 site for those two

generate_ss_seq_coord <- function(df){
  ret = df %>%
    mutate(ss5_start = start - 30,
         ss5_end = start + 29,
         ss3_start = end - 30,
         ss3_end = end + 29 )
  return(ret)
}

as_seq <- generate_ss_seq_coord(res_AS)
no_seq <- generate_ss_seq_coord(res_non_AS)

# write out the table
as_seq %>%
  write_csv('../data/as_RI_seq_coord.csv')

no_seq %>%
  write_csv('../data/no_as_RI_seq_coord.csv')
```

